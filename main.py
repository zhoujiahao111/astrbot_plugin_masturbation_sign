from astrbot.api import logger
from astrbot.api.event import filter, AstrMessageEvent
from astrbot.api.star import Context, Star, register
from astrbot.api.all import Image

import io
from datetime import datetime, timedelta
from .æ•°æ®åº“ import *
from PIL import Image as PIL_Image, ImageDraw, ImageFont

@register("astrbot_plugin_masturbation_sign", "å‘¨ä½³è±ª", "é¹¿æ’ä»¶,è¾“å‡ºæ—¥å†å›¾ç‰‡", "1.0", "")
class SignPlugin(Star):
    def __init__(self, context: Context):
        super().__init__(context)
        self.ç´ ææ–‡ä»¶è·¯å¾„ = os.path.join(os.getcwd(), r"data\plugins\astrbot_plugin_masturbation_sign")

    # @filter.command("é¹¿", alias={'æ’¸', 'ğŸ¦Œ'})
    @filter.regex('[\s\S]*(æ‰‹æ·«|æ‰“é£æœº|æ’¸|é¹¿|ğŸ¦Œ)[\s\S]*')
    async def ç­¾åˆ°(self, event: AstrMessageEvent):
        qqå· = event.get_sender_id()
        ç”¨æˆ·æ˜µç§° = event.get_sender_name()
        å½“å‰æ—¶é—´ = datetime.now().strftime(("%Y-%m-%d"))

        # å­˜å…¥æ•°æ®åº“
        æ˜¯å¦æˆåŠŸ, ç»“æœ = await ç­¾åˆ°å­˜å‚¨æ–¹æ³•(qqå·, å½“å‰æ—¶é—´)

        if not æ˜¯å¦æˆåŠŸ:
            if ç»“æœ == "å·²ç­¾åˆ°":
                # ä¸æç¤º, é˜²æ­¢å› æ­£åˆ™å¤šæ¬¡é‡å¤è§¦å‘, å›å¤çš„æç¤ºä¿¡æ¯é€ æˆéªšæ‰°
                # yield event.plain_result("ä»Šæ—¥å·²ğŸ¦Œ, è¯·å‹¿é‡å¤å–µ")
                return
            else:
                yield event.plain_result("æœªçŸ¥é”™è¯¯:" + ç»“æœ)

            return

        # å–å‡ºå†å²æ•°æ®
        å½“å‰æ—¥æœŸ = datetime.strptime(å½“å‰æ—¶é—´.split()[0], '%Y-%m-%d').date()
        å½“å‰æœˆä»½ = å½“å‰æ—¥æœŸ.strftime('%Y-%m')

        # è½¬ä¸ºæ— å‰ç¼€0çš„çº¯å¤©æ•°
        æœˆä»½æœ€åä¸€å¤©: str = str(
            (
                å½“å‰æ—¥æœŸ.replace(day=28) +
                timedelta(days=4)
            ).replace(day=1) - timedelta(days=1)
        ).split('-')[-1]

        æ˜¯å¦æˆåŠŸ, ç»“æœ = await è·å–ç­¾åˆ°æ—¥å†æ•°æ®(qqå·, å½“å‰æœˆä»½, æœˆä»½æœ€åä¸€å¤©)

        if not æ˜¯å¦æˆåŠŸ:
            yield event.plain_result("ğŸ¦Œå¤±è´¥äº†," + ç»“æœ)
            return

        try:
            # ç”Ÿæˆå›¾ç‰‡
            å›¾ç‰‡bytes = self.ç”Ÿæˆæ—¥å†å›¾ç‰‡(ç”¨æˆ·æ˜µç§°, ç»“æœ)

            if not å›¾ç‰‡bytes:
                return

            # å‘é€å›¾ç‰‡
            yield event.chain_result(
                [
                   Image.fromBytes(å›¾ç‰‡bytes)
                ]
            )

        except Exception as e:
            yield event.plain_result("ğŸ¦Œå›¾ç‰‡ç”Ÿæˆå¤±è´¥äº†: " + str(e))

        return

    def ç”Ÿæˆæ—¥å†å›¾ç‰‡(self, ç”¨æˆ·æ˜µç§°: str, æ•°æ®: dict) -> bytes | None:
        try:
            èƒŒæ™¯å›¾ç‰‡ = PIL_Image.open(self.ç´ ææ–‡ä»¶è·¯å¾„ + r"\èƒŒæ™¯.png").convert("RGBA")
            ç« å›¾ç‰‡ = PIL_Image.open(self.ç´ ææ–‡ä»¶è·¯å¾„ + r"\ç« .png").convert("RGBA")
        except FileNotFoundError as e:
            logger.error(f"æ— æ³•æ‰¾åˆ°ç´ ææ–‡ä»¶ï¼š{e.filename}ã€‚è¯·æ£€æŸ¥è·¯å¾„ï¼š'{self.ç´ ææ–‡ä»¶è·¯å¾„}'æ˜¯å¦æ­£ç¡®ä¸”æ–‡ä»¶å­˜åœ¨ã€‚")
            return

        # ç»˜åˆ¶å™¨ = PIL_Image.Draw.Draw(èƒŒæ™¯å›¾ç‰‡)
        ç»˜åˆ¶å™¨ = ImageDraw.Draw(èƒŒæ™¯å›¾ç‰‡)

        # ä»æ•°æ®å­—å…¸ä¸­æå–æ‰€éœ€ä¿¡æ¯
        æœ¬æœˆç­¾åˆ°å¤©æ•°_æ–‡æœ¬ = æ•°æ®['æœ¬æœˆç­¾åˆ°å¤©æ•°']
        æœ¬æœˆç­¾åˆ°æ—¥æœŸåˆ—è¡¨ = æ•°æ®['æœ¬æœˆç­¾åˆ°æ—¥æœŸåˆ—è¡¨']
        è¿ç»­ç­¾åˆ°çŠ¶æ€_æ–‡æœ¬ = æ•°æ®['è¿ç»­ç­¾åˆ°çŠ¶æ€']
        æœˆä»½æœ€åä¸€å¤© = æ•°æ®['æœˆä»½æœ€åä¸€å¤©']

        å­—ä½“è·¯å¾„ = "msyh.ttc"
        try:
            å¤´éƒ¨å­—ä½“ = ImageFont.truetype("msyh.ttc", 26)
        except IOError:
            å¤´éƒ¨å­—ä½“ = ImageFont.load_default() # å¤‡ç”¨å­—ä½“

        # ç»˜åˆ¶é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
        æ ‡é¢˜åŒºåŸŸ_å·¦ = 160
        æ ‡é¢˜åŒºåŸŸ_ä¸Š = 126
        æ ‡é¢˜åŒºåŸŸ_ä¸‹ = 162

        æ˜µç§°_æ–‡æœ¬æ¡† = ç»˜åˆ¶å™¨.textbbox((0, 0), ç”¨æˆ·æ˜µç§°, font=å¤´éƒ¨å­—ä½“)
        æ˜µç§°_æ–‡æœ¬é«˜åº¦ = æ˜µç§°_æ–‡æœ¬æ¡†[3] - æ˜µç§°_æ–‡æœ¬æ¡†[1]
        æ–‡æœ¬_Y = æ ‡é¢˜åŒºåŸŸ_ä¸Š + (æ ‡é¢˜åŒºåŸŸ_ä¸‹ - æ ‡é¢˜åŒºåŸŸ_ä¸Š - æ˜µç§°_æ–‡æœ¬é«˜åº¦) / 2

        # å³ä¸‹æœˆä»½ä¿¡æ¯
        ç»˜åˆ¶å™¨.text((æ ‡é¢˜åŒºåŸŸ_å·¦+3, æ–‡æœ¬_Y-8), æ•°æ®["å½“å‰æœˆä»½"]+" å·²ç­¾åˆ°", fill="#5C4033", font=å¤´éƒ¨å­—ä½“)
        # ç»˜åˆ¶å™¨.text((630, 372), , fill="black", font=å¤´éƒ¨å­—ä½“)

        # ç»˜åˆ¶æ—¥å†é¡¶éƒ¨ç”¨æˆ·æ˜µç§°
        ç»˜åˆ¶å™¨.text((æ ‡é¢˜åŒºåŸŸ_å·¦+3, æ–‡æœ¬_Y+22), ç”¨æˆ·æ˜µç§°, fill="#5C4033", font=å¤´éƒ¨å­—ä½“)

        # ç»˜åˆ¶åº•éƒ¨ç­¾åˆ°ä¿¡æ¯
        ç»˜åˆ¶å™¨.text((160, 497), æœ¬æœˆç­¾åˆ°å¤©æ•°_æ–‡æœ¬, fill="#5C4033", font=å¤´éƒ¨å­—ä½“)

        ç­¾åˆ°_X = 185 + ç»˜åˆ¶å™¨.textlength(æœ¬æœˆç­¾åˆ°å¤©æ•°_æ–‡æœ¬, font=å¤´éƒ¨å­—ä½“)
        ç»˜åˆ¶å™¨.text((ç­¾åˆ°_X, 497), è¿ç»­ç­¾åˆ°çŠ¶æ€_æ–‡æœ¬, fill="#5C4033", font=å¤´éƒ¨å­—ä½“)

        # 3. ç»˜åˆ¶æ—¥å†æ•°å€¼åŒºåŸŸ
        æ—¥å†åŒºåŸŸ_å·¦ = 183
        æ—¥å†åŒºåŸŸ_ä¸Š = 162
        æ—¥å†åŒºåŸŸ_å³ = 593
        æ—¥å†åŒºåŸŸ_ä¸‹ = 553

        æ—¥å†åŒºåŸŸ_å®½ = æ—¥å†åŒºåŸŸ_å³ - æ—¥å†åŒºåŸŸ_å·¦
        æ—¥å†åŒºåŸŸ_é«˜ = æ—¥å†åŒºåŸŸ_ä¸‹ - æ—¥å†åŒºåŸŸ_ä¸Š

        åˆ—æ•° = 7
        è¡Œæ•° = 6

        å•å…ƒæ ¼_å®½ = æ—¥å†åŒºåŸŸ_å®½ / åˆ—æ•°
        å•å…ƒæ ¼_é«˜ = æ—¥å†åŒºåŸŸ_é«˜ / è¡Œæ•°

        # æ ¹æ®å•å…ƒæ ¼é«˜åº¦è®¡ç®—æ—¥æœŸæ•°å­—çš„å­—ä½“å¤§å°
        æ•°å­—å­—ä½“å¤§å° = int(å•å…ƒæ ¼_é«˜ * 0.6)

        try:
            æ•°å­—å­—ä½“ = ImageFont.truetype(å­—ä½“è·¯å¾„, æ•°å­—å­—ä½“å¤§å°)
        except IOError:
            æ•°å­—å­—ä½“ = ImageFont.load_default() # å¤‡ç”¨å­—ä½“

        å½“å‰æ—¥æœŸ = 1
        # éå†æ—¥å†çš„æ¯ä¸€è¡Œå’Œæ¯ä¸€åˆ—ï¼Œç»˜åˆ¶æ—¥æœŸæ•°å­—

        for è¡Œç´¢å¼• in range(è¡Œæ•°):
            for åˆ—ç´¢å¼• in range(åˆ—æ•°):
                # æ ¹æ®è¦æ±‚ï¼Œâ€œç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªç©ºç¼ºâ€
                if è¡Œç´¢å¼• == 0 and åˆ—ç´¢å¼• == 0:
                    continue

                # å¦‚æœå½“å‰æ—¥æœŸè¶…è¿‡äº†æœˆä»½çš„æœ€åä¸€å¤©ï¼Œåˆ™åœæ­¢ç»˜åˆ¶
                if å½“å‰æ—¥æœŸ > int(æœˆä»½æœ€åä¸€å¤©):
                    break

                # è®¡ç®—å½“å‰æ—¥æœŸæ‰€åœ¨å•å…ƒæ ¼çš„å·¦ä¸Šè§’åæ ‡
                å•å…ƒæ ¼_X = æ—¥å†åŒºåŸŸ_å·¦ + åˆ—ç´¢å¼• * å•å…ƒæ ¼_å®½
                å•å…ƒæ ¼_Y = æ—¥å†åŒºåŸŸ_ä¸Š + è¡Œç´¢å¼• * å•å…ƒæ ¼_é«˜

                # ç»˜åˆ¶æ—¥æœŸæ•°å­—
                æ—¥æœŸå­—ç¬¦ä¸² = str(å½“å‰æ—¥æœŸ)
                # è·å–æ—¥æœŸæ•°å­—æ–‡æœ¬çš„è¾¹ç•Œæ¡†ï¼Œç”¨äºè®¡ç®—å±…ä¸­ä½ç½®
                æ—¥æœŸæ–‡æœ¬æ¡† = ç»˜åˆ¶å™¨.textbbox((0, 0), æ—¥æœŸå­—ç¬¦ä¸², font=æ•°å­—å­—ä½“)

                æ—¥æœŸæ–‡æœ¬å®½ = æ—¥æœŸæ–‡æœ¬æ¡†[2] - æ—¥æœŸæ–‡æœ¬æ¡†[0]
                æ—¥æœŸæ–‡æœ¬é«˜ = æ—¥æœŸæ–‡æœ¬æ¡†[3] - æ—¥æœŸæ–‡æœ¬æ¡†[1]

                # è®¡ç®—æ—¥æœŸæ–‡æœ¬åœ¨å•å…ƒæ ¼å†…å±…ä¸­çš„ä½ç½®
                æ—¥æœŸæ–‡æœ¬_X = å•å…ƒæ ¼_X + (å•å…ƒæ ¼_å®½ - æ—¥æœŸæ–‡æœ¬å®½) / 2
                æ—¥æœŸæ–‡æœ¬_Y = å•å…ƒæ ¼_Y + (å•å…ƒæ ¼_é«˜ - æ—¥æœŸæ–‡æœ¬é«˜) / 2

                ç»˜åˆ¶å™¨.text((æ—¥æœŸæ–‡æœ¬_X, æ—¥æœŸæ–‡æœ¬_Y), æ—¥æœŸå­—ç¬¦ä¸², fill="#4B3B2B", font=æ•°å­—å­—ä½“)

                # å¦‚æœå½“å‰æ—¥æœŸå­˜åœ¨äºâ€œæœ¬æœˆç­¾åˆ°æ—¥æœŸåˆ—è¡¨â€ä¸­ï¼Œåˆ™å åŠ ç« å›¾ç‰‡
                if å½“å‰æ—¥æœŸ in æœ¬æœˆç­¾åˆ°æ—¥æœŸåˆ—è¡¨:
                    ç« _å®½, ç« _é«˜ = ç« å›¾ç‰‡.size
                    # è®¡ç®—ç« å›¾ç‰‡åœ¨å•å…ƒæ ¼å†…å±…ä¸­çš„ä½ç½®
                    ç« _X = int(å•å…ƒæ ¼_X + (å•å…ƒæ ¼_å®½ - ç« _å®½) / 2)
                    ç« _Y = int(å•å…ƒæ ¼_Y + (å•å…ƒæ ¼_é«˜ - ç« _é«˜) / 2) + 8

                    # å åŠ ç« å›¾ç‰‡
                    èƒŒæ™¯å›¾ç‰‡.paste(ç« å›¾ç‰‡, (ç« _X, ç« _Y), ç« å›¾ç‰‡)

                å½“å‰æ—¥æœŸ += 1
            # å¦‚æœå†…å±‚å¾ªç¯å› ä¸ºæ—¥æœŸå·²ç”»å®Œè€Œæå‰è·³å‡ºï¼Œå¤–å±‚å¾ªç¯ä¹Ÿåº”è·³å‡º
            if å½“å‰æ—¥æœŸ > int(æœˆä»½æœ€åä¸€å¤©):
                break

        ç»“æœbytes = io.BytesIO()
        èƒŒæ™¯å›¾ç‰‡.save(ç»“æœbytes, format='PNG')

        return ç»“æœbytes.getvalue()






